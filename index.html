<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self';" />
  <meta name="referrer" content="strict-origin" />
  <title>æœªæˆå¹´èª²é‡‘è¿”é‡‘ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ  | refund.example.com</title>
  <!-- æ³•å¯¾å¿œãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒ¢ï¼ˆå®Ÿè£…è€…å‘ã‘ï¼‰
    - å€‹äººæƒ…å ±ä¿è­·æ³•: åé›†ç›®çš„/ä¿ç®¡æœŸé–“/ç¬¬ä¸‰è€…æä¾›ã‚’æœ¬æ–‡ã§æ˜ç¤ºã€‚å…¥åŠ›ã¯æœ€å°é™ã€‚
    - æ¶ˆè²»è€…å¥‘ç´„æ³•: ç°¡æ½”UIï¼ˆ2åˆ†ä»¥å†…å®Œäº†æƒ³å®šï¼‰ã€‚
    - åˆ‘æ³•246æ¡: æŠ‘æ­¢ã®ãŸã‚æ³¨æ„å–šèµ·ã‚’å†’é ­ã«æ˜ç¤ºã€éåº¦ã«è„…è¿«çš„ãªè¡¨ç¾ã¯é¿ã‘ã‚‹ã€‚
    - è³‡é‡‘æ±ºæ¸ˆæ³•: ã‚­ãƒ£ãƒªã‚¢æ±ºæ¸ˆã®æ¤œè¨¼ç”¨ã«ã€Œå¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã€Œã‚­ãƒ£ãƒªã‚¢ã€ã€Œå¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ã€ã‚’å¿…é ˆåŒ–ã€‚
    - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: CSPã€å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€æ”¹ã–ã‚“æ¤œçŸ¥ã‚’å®Ÿè£…ã€‚
  -->
  <style>
    /* æ¶ˆè²»è€…å¥‘ç´„æ³•: 2åˆ†ä»¥å†…ã§å®Œäº†ã§ãã‚‹ç°¡ç´ UIã€‚å€‹äººæƒ…å ±ä¿è­·æ³•: å¿…è¦æœ€å°é™é …ç›®ï¼‹æ˜ç¤ºã€‚ */

    :root {
      --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --warn:#ff0000; --primary:#007bff; --focus:#2563eb; --success:#10b981;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg)}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;font-size:14px;line-height:1.6}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

    .container{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .notice{margin-bottom:8px}
    .warn{color:var(--warn);font-size:16px}
    
    .page-header{text-align:center;margin-bottom:20px}
    .page-title{color:var(--primary);font-size:24px;margin:0 0 8px 0}
    .page-subtitle{color:var(--muted);font-size:14px;margin:0}
    .security-badge{display:inline-flex;align-items:center;gap:4px;background:#f0f9ff;color:#0369a1;font-size:12px;padding:4px 8px;border-radius:12px;margin-top:8px}

    .field{display:block;margin:12px 0}
    .field>span{display:inline-block;margin-bottom:6px;font-weight:600}
    .req{background:#fee2e2;color:#991b1b;font-size:12px;border-radius:4px;padding:2px 6px;margin-left:6px}

    input[type="text"],input[type="email"],input[type="tel"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px
    }
    input:focus,select:focus{outline:none;border-color:var(--focus);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

    .hint{color:var(--muted);font-size:12px;display:block;margin-top:4px}
    .error{color:#b91c1c;font-size:12px;min-height:16px;display:block;margin-top:4px}

    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tab{padding:8px 12px;border:1px solid var(--border);background:#f9fafb;border-radius:20px;cursor:pointer}
    .tab.active{border-color:var(--primary);background:#eef6ff}
    .tabpane{padding:8px 0}
    .tabpane[hidden]{display:none}
    .tabpane.active{display:block}

    .subfield{display:block;margin:8px 0}
    .subfield span{display:inline-block;margin-bottom:6px}

    .agree{display:flex;align-items:flex-start;gap:8px;margin-top:12px}
    .agree input{margin-top:3px}

    .purpose-confirm{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin:12px 0}
    .purpose-confirm h3{margin:0 0 8px 0;color:var(--primary);font-size:16px}
    .purpose-confirm p{margin:0 0 12px 0;color:var(--muted);font-size:14px}

    .actions{display:flex;align-items:center;gap:12px;margin-top:12px}
    button[type="submit"]{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:10px 16px;font-size:14px;cursor:pointer;transition:transform .02s ease}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .submit-note{font-size:12px;color:var(--muted)}

    .privacy{color:#4b5563;font-size:12px;line-height:1.7}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:16px 0 8px}

    .security-info{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;color:#0369a1}
    .security-info h4{margin:0 0 6px 0;font-size:13px}
    .security-info ul{margin:4px 0;padding-left:16px}
    .security-info li{margin:2px 0}

    @media (min-width:768px){.actions{justify-content:flex-start}}
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="page-title">
    <div class="page-header">
      <h1 id="page-title" class="page-title">æœªæˆå¹´èª²é‡‘è¿”é‡‘ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </h1>
      <p class="page-subtitle">ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯æœªæˆå¹´ã«ã‚ˆã‚‹èª²é‡‘ã®è¿”é‡‘ç”³è«‹å°‚ç”¨ã§ã™</p>
      <div class="security-badge">
        ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢é€ä¿¡å¯¾å¿œ
      </div>
    </div>

    <section class="card">
      <div class="notice" role="note" aria-live="polite">
        <strong class="warn">
          è™šå½ã®æœªæˆå¹´è¿”é‡‘è«‹æ±‚ã¯è©æ¬ºç½ªï¼ˆåˆ‘æ³•246æ¡ï¼‰ã«è©²å½“ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æå‡ºæƒ…å ±ã¯å³æ­£ã«ç¢ºèªã—ã€è™šå½ãŒç™ºè¦šã—ãŸå ´åˆã€æ³•çš„æªç½®ï¼ˆæå®³è³ å„Ÿè«‹æ±‚ã€è­¦å¯Ÿã¸ã®ç›¸è«‡ï¼‰ã‚’è¬›ã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
        </strong>
      </div>

      <form id="refundForm" novalidate>
        <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ -->
        <input type="hidden" name="securityToken" id="securityToken" />
        <input type="hidden" name="formTimestamp" id="formTimestamp" />
        <input type="hidden" name="sessionId" id="sessionId" />

        <!-- å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆå¿…é ˆï¼‰ -->
        <label class="field">
          <span>å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ <span class="req">å¿…é ˆ</span></span>
          <input
            type="text"
            name="targetDomain"
            id="targetDomain"
            required
            placeholder="ä¾‹: example.com"
            inputmode="url"
            autocomplete="off"
            value="example.com"
            maxlength="253"
          />
          <small class="hint">URLã‚’è²¼ã£ã¦ã‚‚å¯ï¼ˆè‡ªå‹•ã§ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºï¼‰ã€‚ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å¯ï¼ˆä¾‹: sub.example.comï¼‰ã€‚</small>
          <small class="error" id="err-targetDomain" aria-live="polite"></small>
        </label>

        <!-- ã‚µãƒ¼ãƒ“ã‚¹åï¼ˆãƒ†ã‚­ã‚¹ãƒˆã€å¿…é ˆï¼‰ -->
        <label class="field">
          <span>ã‚µãƒ¼ãƒ“ã‚¹å <span class="req">å¿…é ˆ</span></span>
          <input type="text" name="serviceName" id="serviceName" required maxlength="100" placeholder="ä¾‹: Story Landï¼ˆé›»å­æ›¸ç±ï¼‰" />
          <small class="error" id="err-serviceName" aria-live="polite"></small>
        </label>

        <!-- ã‚­ãƒ£ãƒªã‚¢ï¼ˆå¿…é ˆï¼‰ -->
        <label class="field">
          <span>ã‚­ãƒ£ãƒªã‚¢ <span class="req">å¿…é ˆ</span></span>
          <select name="carrier" id="carrier" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="docomo">docomoï¼ˆahamoï¼‰</option>
            <option value="au">auï¼ˆpovoã€UQ mobileï¼‰</option>
            <option value="softbank">SoftBankï¼ˆLINEMOï¼‰</option>
          </select>
          <small class="error" id="err-carrier" aria-live="polite"></small>
        </label>

        <!-- å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ï¼ˆå¿…é ˆï¼šã‚­ãƒ£ãƒªã‚¢ã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«å‹•çš„è¡¨ç¤ºï¼‰ -->
        <label class="field">
          <span id="paymentIdLabel">å¯¾è±¡ã®æ±ºæ¸ˆç•ªå· <span class="req">å¿…é ˆ</span></span>
          <input type="text" name="paymentId" id="paymentId" required placeholder="ä¾‹: xxxx-xxxx-xxxx" autocomplete="off" maxlength="50" />
          <small class="hint">
            â€» ä¸æ˜ãªå ´åˆã¯ç¢ºèªæ–¹æ³•ã®æ¡ˆå†…ï¼ˆ<a href="https://334.jp" target="_blank" rel="noopener">334.jp</a>ï¼‰ã‚’ã”è¦§ãã ã•ã„ã€‚
          </small>
          <small class="error" id="err-paymentId" aria-live="polite"></small>
        </label>

        <!-- ç”³è«‹å†…å®¹ã®ç¢ºèª -->
        <div class="purpose-confirm">
          <h3>ç”³è«‹å†…å®¹ã®ç¢ºèª</h3>
          <p>ä»¥ä¸‹ã®å†…å®¹ã«ã¤ã„ã¦ç¢ºèªã—ã€åŒæ„ã®ä¸Šã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
          <label class="agree">
            <input type="checkbox" name="reasonConfirm" id="reasonConfirm" required />
            <span>æœªæˆå¹´ã«ã‚ˆã‚‹èª²é‡‘ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€è¿”é‡‘ç”³è«‹ã„ãŸã—ã¾ã™</span>
          </label>
          <small class="error" id="err-reasonConfirm" aria-live="polite"></small>
        </div>

        <!-- ç”Ÿå¹´æœˆæ—¥ï¼ˆ18æ­³æœªæº€ã®ã¿æœ‰åŠ¹ï¼‰ -->
        <label class="field">
          <span>ç”Ÿå¹´æœˆæ—¥ï¼ˆYYYY/MM/DDï¼‰ <span class="req">å¿…é ˆ</span></span>
          <input type="text" name="dob" id="dob" inputmode="numeric" placeholder="ä¾‹: 2008/03/05" required maxlength="10" />
          <small class="hint">18æ­³æœªæº€ã®ã¿ç”³è«‹å¯èƒ½ï¼ˆå½“æ—¥åŸºæº–ï¼‰ã€‚æœªæ¥æ—¥ãƒ»ä¸æ­£ãªéå»å¹´ï¼ˆä¾‹: 1900å¹´ï¼‰ã¯ä¸å¯ã€‚</small>
          <small class="error" id="err-dob" aria-live="polite"></small>
        </label>

        <!-- è¦ªæ¨©è€…/ä¿è­·è€… æ°å -->
        <label class="field">
          <span>è¦ªæ¨©è€…/ä¿è­·è€…ã®æ°å <span class="req">å¿…é ˆ</span></span>
          <input type="text" name="guardianName" id="guardianName" maxlength="50" required placeholder="ä¾‹: å±±ç”° å¤ªéƒ" />
          <small class="error" id="err-guardianName" aria-live="polite"></small>
        </label>

        <!-- é€£çµ¡å…ˆï¼ˆãƒ¡ãƒ¼ãƒ« or é›»è©±ï¼‰ -->
        <fieldset class="field">
          <legend>è¦ªæ¨©è€…/ä¿è­·è€…ã®é€£çµ¡å…ˆ <span class="req">å¿…é ˆ</span></legend>
          <div class="tabs" role="tablist" aria-label="é€£çµ¡æ–¹æ³•">
            <button type="button" class="tab active" data-target="#emailPane" role="tab" aria-selected="true">ãƒ¡ãƒ¼ãƒ«</button>
            <button type="button" class="tab" data-target="#phonePane" role="tab" aria-selected="false">é›»è©±</button>
          </div>

          <div id="emailPane" class="tabpane active" role="tabpanel">
            <label class="subfield">
              <span>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: example@domain.comï¼‰</span>
              <input type="email" name="guardianEmail" id="guardianEmail" placeholder="ä¾‹: parent@example.com" maxlength="100" />
              <small class="error" id="err-guardianEmail" aria-live="polite"></small>
            </label>
          </div>

          <div id="phonePane" class="tabpane" role="tabpanel" hidden>
            <label class="subfield">
              <span>é›»è©±ç•ªå·ï¼ˆ+81-123-456-7890 å½¢å¼ï¼‰</span>
              <input type="tel" name="guardianPhone" id="guardianPhone" placeholder="+81-90-1234-5678" maxlength="20" />
              <small class="error" id="err-guardianPhone" aria-live="polite"></small>
            </label>
          </div>

          <small class="hint">â€» ãƒ¡ãƒ¼ãƒ«ã‹é›»è©±ã®ã„ãšã‚Œã‹ä¸€æ–¹ã¯å¿…é ˆã€‚å•ã„åˆã‚ã›æ™‚ã®é€£çµ¡å…ˆã¨ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚</small>
        </fieldset>

        <!-- åŒæ„ãƒã‚§ãƒƒã‚¯ -->
        <label class="agree">
          <input type="checkbox" id="consent" required />
          <span>ç§ã¯æå‡ºæƒ…å ±ã®æ­£ç¢ºæ€§ã‚’ä¿è¨¼ã—ã€è™šå½ç”³å‘ŠãŒç™ºè¦šã—ãŸå ´åˆã®è²¬ä»»ï¼ˆæ³•çš„æªç½®ã‚’å«ã‚€ï¼‰ã‚’äº†æ‰¿ã—ã¾ã™ã€‚</span>
        </label>
        <small class="error" id="err-consent" aria-live="polite"></small>

        <!-- é€ä¿¡ -->
        <div class="actions">
          <button id="submitBtn" type="submit" disabled>ç”³è«‹ã‚’é€ä¿¡</button>
          <div id="submitNote" class="submit-note" aria-live="polite"></div>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="security-info">
        <h4>ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</h4>
        <ul>
          <li>å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯æš—å·åŒ–ã•ã‚Œã¦é€ä¿¡ã•ã‚Œã¾ã™</li>
          <li>ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚¹ãƒ‘ãƒ é€ä¿¡ã‚’ç›£è¦–ã—ã¦ã„ã¾ã™</li>
          <li>è¤‡æ•°å›ã®é€ä¿¡ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</li>
          <li>IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»æ™‚åˆ»ç­‰ã®ãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™</li>
        </ul>
      </div>
    </section>

    <section class="card">
      <p class="privacy">
        åé›†ç›®çš„ï¼šè¿”é‡‘ç”³è«‹ã®å‡¦ç†ãŠã‚ˆã³ä¸æ­£é˜²æ­¢<br>
        åé›†æƒ…å ±ï¼šç”Ÿå¹´æœˆæ—¥ã€è¦ªæ¨©è€…æ°åãƒ»é€£çµ¡å…ˆã€å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚­ãƒ£ãƒªã‚¢ã€å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ã€ã‚µãƒ¼ãƒ“ã‚¹å<br>
        ä¿ç®¡æœŸé–“ï¼šç”³è«‹å‡¦ç†å¾Œ3ãƒ¶æœˆã§å‰Šé™¤<br>
        ç¬¬ä¸‰è€…æä¾›ï¼šã‚­ãƒ£ãƒªã‚¢æ±ºæ¸ˆäº‹æ¥­è€…ã«å¹´é½¢ç¢ºèªã®ãŸã‚æä¾›ã™ã‚‹å ´åˆã‚ã‚Š<br>
        ãŠå•ã„åˆã‚ã›ï¼šsupport@refund.example.com
      </p>
    </section>

    <footer class="footer">
      <small>&copy; 2025 refund.example.com | è¤‡æ•°ã‚µã‚¤ãƒˆä¸€å…ƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </small>
    </footer>
  </main>

  <script>
    /* æ³•ã¨è¨­è¨ˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒ¢
     - å€‹äººæƒ…å ±ä¿è­·æ³•: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ã§å‡¦ç†ï¼ˆGitHub Pagesï¼‰ã€‚ã‚µãƒ¼ãƒä¿å­˜ãªã—ãƒ‡ãƒ¢ã€‚
     - æ¶ˆè²»è€…å¥‘ç´„æ³•: å…¥åŠ›5é …ç›®ã€2åˆ†ä»¥å†…å®Œäº†æƒ³å®šã€‚
     - åˆ‘æ³•246æ¡: æŠ‘æ­¢æ–‡è¨€ã‚’è¡¨ç¤ºã€‚
     - è³‡é‡‘æ±ºæ¸ˆæ³•: ã€Œå¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã€Œã‚­ãƒ£ãƒªã‚¢ã€ã€Œå¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ã€ã‚’å¿…é ˆåŒ–ã€‚
     - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€æ”¹ã–ã‚“æ¤œçŸ¥ã€ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã€‚
    */

    const $ = (s) => document.querySelector(s);

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: åˆæœŸåŒ–æ™‚ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ
    (function initSecurity(){
      const generateToken = () => Math.random().toString(36).substring(2) + Date.now().toString(36);
      const sessionId = 'session_' + generateToken();
      const securityToken = 'token_' + generateToken();
      const timestamp = Date.now();
      
      $("#securityToken").value = securityToken;
      $("#formTimestamp").value = timestamp;
      $("#sessionId").value = sessionId;
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆæ”¹ã–ã‚“æ¤œçŸ¥ç”¨ï¼‰
      sessionStorage.setItem('formSession', JSON.stringify({
        sessionId: sessionId,
        securityToken: securityToken,
        timestamp: timestamp
      }));
    })();

    // å…¥åŠ›å€¤ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
    function sanitizeInput(input) {
      return input.toString()
        .replace(/[<>\"'&]/g, function(match) {
          const map = {'<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '&': '&amp;'};
          return map[match];
        })
        .trim()
        .substring(0, 1000); // æœ€å¤§é•·åˆ¶é™
    }

    // é«˜åº¦ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆè¤‡æ•°ã®æŒ‡æ¨™ã§åˆ¤å®šï¼‰
    function checkAdvancedRateLimit() {
      const now = Date.now();
      const hour = 3600000;
      const day = 86400000;
      
      // æ™‚é–“åˆ¥åˆ¶é™
      let hourlySubmissions = [];
      let dailySubmissions = [];
      
      try {
        hourlySubmissions = JSON.parse(sessionStorage.getItem('hourly_submissions') || '[]');
        dailySubmissions = JSON.parse(sessionStorage.getItem('daily_submissions') || '[]');
      } catch(e) {
        hourlySubmissions = [];
        dailySubmissions = [];
      }
      
      // å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
      hourlySubmissions = hourlySubmissions.filter(ts => now - ts < hour);
      dailySubmissions = dailySubmissions.filter(ts => now - ts < day);
      
      // åˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (hourlySubmissions.length >= 3) {
        alert("1æ™‚é–“ã«3å›ä»¥ä¸Šã®ç”³è«‹ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        return false;
      }
      
      if (dailySubmissions.length >= 10) {
        alert("1æ—¥ã®ç”³è«‹ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥ä»¥é™ã«ãŠè©¦ã—ãã ã•ã„ã€‚");
        return false;
      }
      
      // è¨˜éŒ²
      hourlySubmissions.push(now);
      dailySubmissions.push(now);
      
      sessionStorage.setItem('hourly_submissions', JSON.stringify(hourlySubmissions));
      sessionStorage.setItem('daily_submissions', JSON.stringify(dailySubmissions));
      
      return true;
    }

    /** ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆãƒ¡ãƒ¼ãƒ«/é›»è©±ï¼‰ */
    (function setupTabs(){
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach(tab=>{
        tab.addEventListener("click",()=>{
          tabs.forEach(t=>t.classList.remove("active"));
          tab.classList.add("active");
          const targetSel = tab.getAttribute("data-target");
          document.querySelectorAll(".tabpane").forEach(p=>{
            if("#"+p.id===targetSel){ p.hidden=false; p.classList.add("active"); }
            else { p.hidden=true; p.classList.remove("active"); }
          });
        });
      });
    })();

    /** åŒæ„ã‚²ãƒ¼ãƒˆï¼ˆä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¿…è¦ï¼‰ */
    (function consentGate(){
      const consent=$("#consent"), reasonConfirm=$("#reasonConfirm"), btn=$("#submitBtn");
      if(!consent||!reasonConfirm||!btn) return;
      const update=()=>btn.disabled=!(consent.checked && reasonConfirm.checked);
      consent.addEventListener("change",update);
      reasonConfirm.addEventListener("change",update);
      update();
    })();

    /** ã‚­ãƒ£ãƒªã‚¢é¸æŠã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«ã‚’å‹•çš„å¤‰æ›´ */
    (function carrierDynamicLabel(){
      const carrier=$("#carrier"), label=$("#paymentIdLabel");
      const update=()=>{
        const v=carrier.value;
        if(v==="docomo"){
          label.innerHTML='å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ï¼ˆ<b>docomoãƒ»ahamo: æ±ºæ¸ˆç•ªå·</b>ï¼‰ <span class="req">å¿…é ˆ</span>';
        }else if(v==="au"){
          label.innerHTML='å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ï¼ˆ<b>auãƒ»povoãƒ»UQ mobile: ç¶™ç¶šèª²é‡‘ID</b>ï¼‰ <span class="req">å¿…é ˆ</span>';
        }else if(v==="softbank"){
          label.innerHTML='å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ï¼ˆ<b>SoftBankãƒ»LINEMO: æ³¨æ–‡ç•ªå·</b>ï¼‰ <span class="req">å¿…é ˆ</span>';
        }else{
          label.innerHTML='å¯¾è±¡ã®æ±ºæ¸ˆç•ªå· <span class="req">å¿…é ˆ</span>';
        }
      };
      if(carrier){ carrier.addEventListener("change",update); update(); }
    })();

    /** å…¥åŠ›æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ */
    function validateForm(){
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
      [
        "#err-targetDomain","#err-serviceName","#err-carrier","#err-paymentId",
        "#err-reasonConfirm","#err-dob","#err-guardianName",
        "#err-guardianEmail","#err-guardianPhone","#err-consent"
      ].forEach(sel=>{ const el=$(sel); if(el) el.textContent=""; });

      // å€¤ã®å–å¾—ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
      const targetDomain = sanitizeInput($("#targetDomain").value);
      const serviceName = sanitizeInput($("#serviceName").value);
      const carrier = sanitizeInput($("#carrier").value);
      const paymentId = sanitizeInput($("#paymentId").value);
      const reasonConfirm = $("#reasonConfirm").checked;
      const dob = sanitizeInput($("#dob").value);
      const guardianName = sanitizeInput($("#guardianName").value);
      const guardianEmail = sanitizeInput($("#guardianEmail").value);
      const guardianPhone = sanitizeInput($("#guardianPhone").value);
      const consent = $("#consent").checked;

      let ok = true;

      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
      const storedSession = JSON.parse(sessionStorage.getItem('formSession') || '{}');
      if ($("#securityToken").value !== storedSession.securityToken) {
        alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
        return false;
      }

      // å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³
      const extracted = extractHostname(targetDomain);
      if(!extracted){ ok=false; $("#err-targetDomain").textContent="å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: example.comï¼‰ã€‚"; }
      else if(!isValidDomain(extracted)){ ok=false; $("#err-targetDomain").textContent="ãƒ‰ãƒ¡ã‚¤ãƒ³å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; }

      // ã‚µãƒ¼ãƒ“ã‚¹å
      if(!serviceName){ ok=false; $("#err-serviceName").textContent="ã‚µãƒ¼ãƒ“ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }
      else if(serviceName.length>100){ ok=false; $("#err-serviceName").textContent="100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }

      // ã‚­ãƒ£ãƒªã‚¢
      if(!carrier){ ok=false; $("#err-carrier").textContent="ã‚­ãƒ£ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"; }
      else if(!['docomo','au','softbank'].includes(carrier)){ ok=false; $("#err-carrier").textContent="æ­£ã—ã„ã‚­ãƒ£ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"; }

      // æ±ºæ¸ˆç•ªå·ï¼ˆå³æ ¼åŒ–ï¼‰
      if(!paymentId){ ok=false; $("#err-paymentId").textContent="å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }
      else if(!/^[A-Za-z0-9\-_]{3,50}$/.test(paymentId)){
        ok=false; $("#err-paymentId").textContent="æ±ºæ¸ˆç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆè‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€3-50æ–‡å­—ï¼‰ã€‚";
      }

      // ç”³è«‹å†…å®¹ç¢ºèª
      if(!reasonConfirm){ ok=false; $("#err-reasonConfirm").textContent="ç”³è«‹å†…å®¹ã®ç¢ºèªã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚"; }

      // ç”Ÿå¹´æœˆæ—¥
      const dobResult = validateDOB(dob);
      if(!dobResult.valid){ ok=false; $("#err-dob").textContent=dobResult.message; }
      else if(!dobResult.isMinor){ ok=false; $("#err-dob").textContent="æœªæˆå¹´è€…ã«è©²å½“ã—ã¾ã›ã‚“ã€‚"; }

      // è¦ªæ¨©è€…æ°å
      if(!guardianName){ ok=false; $("#err-guardianName").textContent="è¦ªæ¨©è€…/ä¿è­·è€…ã®æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }
      else if(!/^[ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ a-zA-Z\sã€€]+$/.test(guardianName)){ ok=false; $("#err-guardianName").textContent="æ°åã¯æ—¥æœ¬èªã¾ãŸã¯è‹±èªã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }

      // é€£çµ¡å…ˆï¼ˆãƒ¡ãƒ¼ãƒ« or é›»è©±ï¼‰
      const emailOk = guardianEmail ? validateEmail(guardianEmail) : false;
      const phoneOk = guardianPhone ? validateJPPhone(guardianPhone) : false;
      if(!guardianEmail && !guardianPhone){
        ok=false;
        $("#err-guardianEmail").textContent="ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯é›»è©±ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        $("#err-guardianPhone").textContent="ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯é›»è©±ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }else{
        if(guardianEmail && !emailOk){ ok=false; $("#err-guardianEmail").textContent="ãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; }
        if(guardianPhone && !phoneOk){ ok=false; $("#err-guardianPhone").textContent="é›»è©±ç•ªå·ã¯ +81-123-456-7890 å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; }
      }

      // åŒæ„
      if(!consent){ ok=false; $("#err-consent").textContent="åŒæ„ãŒå¿…è¦ã§ã™ã€‚"; }

      return ok;
    }

    /** ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºãƒ»æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ */
    function extractHostname(input){
      if(!input) return "";
      let s = input.trim();
      try{
        if(/^https?:\/\//i.test(s)){ const u=new URL(s); return u.hostname; }
        s = s.replace(/^[a-z]+:\/\//i,"").split("/")[0];
        return s;
      }catch{ return ""; }
    }
    
    function isValidDomain(host){
      if(!host || host.length > 253) return false;
      const re=/^(?=.{1,253}$)(?:[A-Za-z0-9](?:[A-Za-z0-9\-]{0,61}[A-Za-z0-9])\.)+[A-Za-z]{2,}$/;
      return re.test(host) && !host.includes('..') && !host.startsWith('-') && !host.endsWith('-');
    }

    /** DOB æ¤œè¨¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ */
    function validateDOB(s){
      if(!/^\d{4}\/\d{2}\/\d{2}$/.test(s)){
        return {valid:false,message:"ç”Ÿå¹´æœˆæ—¥ã¯ YYYY/MM/DD å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",isMinor:false};
      }
      const [y,m,d]=s.split("/").map(Number);
      if(y<1990||y>2020||m<1||m>12||d<1||d>31){
        return {valid:false,message:"ç”Ÿå¹´æœˆæ—¥ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1990-2020å¹´ã®ç¯„å›²ï¼‰ã€‚",isMinor:false};
      }
      const dt=new Date(y,m-1,d);
      if(dt.getFullYear()!==y||dt.getMonth()!==m-1||dt.getDate()!==d){
        return {valid:false,message:"å­˜åœ¨ã—ãªã„æ—¥ä»˜ã§ã™ã€‚",isMinor:false};
      }
      const today=new Date();
      if(dt>today) return {valid:false,message:"æœªæ¥ã®æ—¥ä»˜ã¯æŒ‡å®šã§ãã¾ã›ã‚“ã€‚",isMinor:false};
      const threshold=new Date(today.getFullYear()-18,today.getMonth(),today.getDate());
      const isMinor = dt>threshold;
      return {valid:true,message:"",isMinor};
    }

    /** Email / Phoneï¼ˆå¼·åŒ–ç‰ˆï¼‰ */
    function validateEmail(s){ 
      return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(s) && s.length <= 100; 
    }
    
    function validateJPPhone(s){ 
      return /^\+81-\d{1,4}-\d{1,4}-\d{3,4}$/.test(s) && s.length <= 20; 
    }

    /** é€ä¿¡ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰ */
    async function submitForm(e){
      e.preventDefault();
      
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
      if(!checkAdvancedRateLimit()) return;
      
      if(!validateForm()) return;

      $("#submitNote").textContent="é€ä¿¡å‡¦ç†ä¸­â€¦";

      const data = collectFormData();
      
      // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆï¼ˆæ”¹ã–ã‚“æ¤œçŸ¥ç”¨ï¼‰
      const dataString = JSON.stringify(data);
      const timestamp = Date.now();
      const hash = await simpleHash(dataString + timestamp);

      const recipient="support@refund.example.com";
      const subject=encodeURIComponent(`ã€æœªæˆå¹´è¿”é‡‘ç”³è«‹ã€‘${data.serviceName} / ${data.carrier} / ${data.paymentId}`);
      const body=encodeURIComponent([
        "=== æœªæˆå¹´èª²é‡‘è¿”é‡‘ç”³è«‹ ===",
        `ç”³è«‹æ—¥æ™‚: ${new Date().toLocaleString()}`,
        `ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${data.sessionId}`,
        `ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚·ãƒ¥: ${hash}`,
        "",
        "ã€ç”³è«‹å†…å®¹ã€‘",
        `å¯¾è±¡ãƒ‰ãƒ¡ã‚¤ãƒ³: ${data.targetDomain}`,
        `ã‚µãƒ¼ãƒ“ã‚¹å: ${data.serviceName}`,
        `ã‚­ãƒ£ãƒªã‚¢: ${data.carrier}`,
        `å¯¾è±¡ã®æ±ºæ¸ˆç•ªå·: ${data.paymentId}`,
        `ç”Ÿå¹´æœˆæ—¥: ${data.dob}`,
        `è¦ªæ¨©è€…æ°å: ${data.guardianName}`,
        `è¦ªæ¨©è€…é€£çµ¡å…ˆ: ${data.guardianEmail || data.guardianPhone}`,
        "",
        "ã€æŠ€è¡“æƒ…å ±ã€‘",
        `UA: ${navigator.userAgent}`,
        `ãƒšãƒ¼ã‚¸: ${location.href}`,
        `é€ä¿¡æ™‚åˆ»: ${timestamp}`,
        "",
        "â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™"
      ].join("\n"));
      
      const mailtoURL=`mailto:${recipient}?subject=${subject}&body=${body}`;
      window.location.href=mailtoURL;

      $("#submitNote").textContent="ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚é€šå¸¸3ã€œ5å–¶æ¥­æ—¥ä»¥å†…ã«çµæœã‚’é€šçŸ¥ã—ã¾ã™ã€‚";
      $("#refundForm").reset();
      $("#submitBtn").disabled=true;
      
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
      console.log(`[SECURITY] Form submitted - Session: ${data.sessionId}, Hash: ${hash}, Time: ${timestamp}`);
    }

    /** ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥é–¢æ•° */
    async function simpleHash(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
    }

    /** å€¤ã®åé›†ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰ */
    function collectFormData(){
      return {
        targetDomain: extractHostname(sanitizeInput($("#targetDomain").value)),
        serviceName: sanitizeInput($("#serviceName").value),
        carrier: sanitizeInput($("#carrier").value),
        paymentId: sanitizeInput($("#paymentId").value),
        dob: sanitizeInput($("#dob").value),
        guardianName: sanitizeInput($("#guardianName").value),
        guardianEmail: sanitizeInput($("#guardianEmail").value),
        guardianPhone: sanitizeInput($("#guardianPhone").value),
        securityToken: $("#securityToken").value,
        sessionId: $("#sessionId").value,
        formTimestamp: $("#formTimestamp").value
      };
    }

    /** å…¥åŠ›è£œåŠ© */
    $("#dob").addEventListener("blur",()=>{
      const r=validateDOB(sanitizeInput($("#dob").value));
      $("#err-dob").textContent=r.valid?"":r.message;
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: ä¸æ­£ãªæ“ä½œã®æ¤œçŸ¥
    document.addEventListener('contextmenu', function(e) {
      // å³ã‚¯ãƒªãƒƒã‚¯åˆ¶é™ã¯å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£é‡è¦–ï¼‰
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: DevToolsæ¤œçŸ¥ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    let devtools = {open: false};
    setInterval(function() {
      if (window.outerHeight - window.innerHeight > 200) {
        if (!devtools.open) {
          devtools.open = true;
          console.log('[SECURITY] Developer tools detected');
        }
      } else {
        devtools.open = false;
      }
    }, 500);

    /** é€ä¿¡ */
    $("#refundForm").addEventListener("submit",submitForm);
  </script>
</body>
</html>